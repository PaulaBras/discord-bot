<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Question Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        form, .controls {
            margin-bottom: 20px;
        }
        input, textarea, select {
            width: 100%;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .answer-list {
            list-style-type: none;
            padding: 0;
        }
        .answer-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .answer-item input[type="checkbox"] {
            margin-right: 5px;
        }
        .answer-item input[type="text"] {
            flex-grow: 1;
        }
        .answer-item button {
            margin-left: 5px;
        }
        .hidden {
            display: none;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        .correct-btn {
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 2px 2px;
            cursor: pointer;
        }
        .correct-btn.correct {
            background-color: #4CAF50;
        }
        .correct-btn.incorrect {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Daily Question Manager</h1>
    
    <form id="questionForm">
        <input type="hidden" id="questionId">
        <input type="text" id="questionText" placeholder="Question" required>
        <div id="answerList">
            <div class="answer-item">
                <input type="text" class="answer-input" placeholder="Answer 1" required>
                <button type="button" class="correct-btn incorrect" onclick="toggleAnswerCorrect(this)">Incorrect</button>
            </div>
        </div>
        <button type="button" onclick="addAnswerInput()">Add Answer</button>
        <input type="date" id="day" required>
        <button type="submit">Add/Update Question</button>
    </form>

    <div class="controls">
        <button id="toggleQuestions">Show Questions</button>
    </div>

    <table id="questionTable" class="hidden">
        <thead>
            <tr>
                <th>Question</th>
                <th>Answers</th>
                <th>Day</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="pagination">
        <button id="prevPage">Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let allQuestions = [];
        let currentPage = 1;
        const questionsPerPage = 5;

        async function fetchQuestions() {
            try {
                const response = await fetch(`${API_URL}/questions`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allQuestions = await response.json();
                updateQuestionTable();
            } catch (error) {
                console.error('Error fetching questions:', error);
                alert('Failed to fetch questions. Please try again.');
            }
        }

        function updateQuestionTable() {
            const tbody = document.querySelector('#questionTable tbody');
            tbody.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            const filteredQuestions = allQuestions.filter(q => q.day >= today);

            const startIndex = (currentPage - 1) * questionsPerPage;
            const endIndex = startIndex + questionsPerPage;
            const paginatedQuestions = filteredQuestions.slice(startIndex, endIndex);

            paginatedQuestions.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.question_text}</td>
                    <td>${createAnswerList(q.answers, q.id, q.correct_answers)}</td>
                    <td>${formatDate(q.day)}</td>
                    <td>
                        <button onclick="editQuestion(${q.id})">Edit</button>
                        <button onclick="deleteQuestion(${q.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updatePagination(filteredQuestions.length);
        }

        function createAnswerList(answers, questionId, correctAnswers) {
            return `<ul class="answer-list">${answers.map((answer, index) => 
                `<li class="answer-item">
                    ${answer}
                    <button class="correct-btn ${correctAnswers.includes(answer) ? 'correct' : 'incorrect'}" 
                            onclick="toggleCorrectAnswer(${questionId}, ${index})">
                        ${correctAnswers.includes(answer) ? 'Correct' : 'Incorrect'}
                    </button>
                </li>`
            ).join('')}</ul>`;
        }

        async function addOrUpdateQuestion(event) {
            event.preventDefault();
            const id = document.getElementById('questionId').value;
            const question_text = document.getElementById('questionText').value;
            const answerItems = document.querySelectorAll('.answer-item');
            const answers = [];
            const correct_answers = [];
            answerItems.forEach(item => {
                const answerText = item.querySelector('.answer-input').value;
                answers.push(answerText);
                if (item.querySelector('.correct-btn').classList.contains('correct')) {
                    correct_answers.push(answerText);
                }
            });
            const day = document.getElementById('day').value;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/questions/${id}` : `${API_URL}/questions`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_text, answers, correct_answers, day })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                document.getElementById('questionForm').reset();
                document.getElementById('questionId').value = '';
                document.getElementById('answerList').innerHTML = `
                    <div class="answer-item">
                        <input type="text" class="answer-input" placeholder="Answer 1" required>
                        <button type="button" class="correct-btn incorrect" onclick="toggleAnswerCorrect(this)">Incorrect</button>
                    </div>
                `;
                setDefaultDate();
                await fetchQuestions();
                alert(id ? 'Question updated successfully!' : 'Question added successfully!');
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving the question. Please try again.');
            }
        }

        async function editQuestion(id) {
            const question = allQuestions.find(q => q.id === id);
            document.getElementById('questionId').value = question.id;
            document.getElementById('questionText').value = question.question_text;
            document.getElementById('answerList').innerHTML = question.answers.map((answer, index) => 
                `<div class="answer-item">
                    <input type="text" class="answer-input" placeholder="Answer ${index + 1}" value="${answer}" required>
                    <button type="button" class="correct-btn ${question.correct_answers.includes(answer) ? 'correct' : 'incorrect'}" 
                            onclick="toggleAnswerCorrect(this)">
                        ${question.correct_answers.includes(answer) ? 'Correct' : 'Incorrect'}
                    </button>
                </div>`
            ).join('');
            document.getElementById('day').value = formatDate(question.day);
        }

        async function deleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    const response = await fetch(`${API_URL}/questions/${id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    await fetchQuestions();
                    alert('Question deleted successfully!');
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the question. Please try again.');
                }
            }
        }

        async function toggleCorrectAnswer(questionId, answerIndex) {
            const question = allQuestions.find(q => q.id === questionId);
            const answer = question.answers[answerIndex];
            const isCorrect = !question.correct_answers.includes(answer);
            
            if (isCorrect) {
                question.correct_answers.push(answer);
            } else {
                question.correct_answers = question.correct_answers.filter(a => a !== answer);
            }

            try {
                const response = await fetch(`${API_URL}/questions/${questionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(question)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await fetchQuestions();
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the answer status. Please try again.');
            }
        }

        function toggleAnswerCorrect(button) {
            if (button.classList.contains('correct')) {
                button.classList.remove('correct');
                button.classList.add('incorrect');
                button.textContent = 'Incorrect';
            } else {
                button.classList.remove('incorrect');
                button.classList.add('correct');
                button.textContent = 'Correct';
            }
        }

        function addAnswerInput() {
            const answerList = document.getElementById('answerList');
            const newAnswerItem = document.createElement('div');
            newAnswerItem.className = 'answer-item';
            newAnswerItem.innerHTML = `
                <input type="text" class="answer-input" placeholder="Answer ${answerList.children.length + 1}" required>
                <button type="button" class="correct-btn incorrect" onclick="toggleAnswerCorrect(this)">Incorrect</button>
            `;
            answerList.appendChild(newAnswerItem);
        }

        function updatePagination(totalQuestions) {
            const totalPages = Math.ceil(totalQuestions / questionsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().split('T')[0];
        }

        function setDefaultDate() {
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            document.getElementById('day').value = today.toISOString().split('T')[0];
        }

        document.getElementById('questionForm').addEventListener('submit', addOrUpdateQuestion);
        document.getElementById('toggleQuestions').addEventListener('click', function() {
            const table = document.getElementById('questionTable');
            const button = document.getElementById('toggleQuestions');
            if (table.classList.contains('hidden')) {
                table.classList.remove('hidden');
                button.textContent = 'Hide Questions';
            } else {
                table.classList.add('hidden');
                button.textContent = 'Show Questions';
            }
        });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateQuestionTable();
            }
        });
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(allQuestions.length / questionsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateQuestionTable();
            }
        });

        // Set the default date to today when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDate();
            fetchQuestions();
        });
    </script>
</body>
</html>